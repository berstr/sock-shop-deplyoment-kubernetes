apiVersion: apps/v1
kind: Deployment
metadata:
      name: orders
      labels:
            name: orders
      namespace: sock-shop
spec:
      selector:
            matchLabels:
                  name: orders
      replicas: 1
      template:
            metadata:
                  labels:
                        name: orders
            spec:
                  containers:
                        - name: orders
                          image: weaveworksdemos/orders:0.4.7
                          env:
                                - name: NEW_RELIC_LICENSE_KEY
                                  value: < NEW_RELIC_LICENSE_KEY >
                                - name: NEW_RELIC_APP_NAME
                                  value: "sock-shop-order"
                                - name: NEW_RELIC_DISTRIBUTED_TRACING_ENABLED
                                  value: "true"
                                - name: NEW_RELIC_LOG_FILE_NAME
                                  value: STDOUT
                                - name: NEW_RELIC_CA_BUNDLE_PATH
                                  value: DOES_NOT_EXISTS
                                - name: JAVA_OPTS
                                  value: -javaagent:/agent.jar -Dspring.sleuth.enabled=false -Xms64m -Xmx128m -XX:PermSize=32m -XX:MaxPermSize=64m -XX:+UseG1GC -Djava.security.egd=file:/dev/urandom
                          resources:
                                limits:
                                      cpu: 100m
                                      memory: 100Mi
                                requests:
                                      cpu: 90m
                                      memory: 100Mi
                          ports:
                                - containerPort: 80
                          securityContext:
                                runAsNonRoot: true
                                runAsUser: 10001
                                capabilities:
                                      drop:
                                            - all
                                      add:
                                            - NET_BIND_SERVICE
                                readOnlyRootFilesystem: true
                          livenessProbe:
                                httpGet:
                                      path: /health
                                      port: 80
                                initialDelaySeconds: 60
                                periodSeconds: 3
                          readinessProbe:
                                httpGet:
                                      path: /health
                                      port: 80
                                initialDelaySeconds: 30
                                periodSeconds: 3
                  nodeSelector:
                        beta.kubernetes.io/os: linux
---
apiVersion: v1
kind: Service
metadata:
      name: orders
      labels:
            name: orders
      namespace: sock-shop
spec:
      ports:
            # the port that this service should serve on
            - port: 80
              targetPort: 80
      selector:
            name: orders
